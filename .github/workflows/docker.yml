name: Docker release

on:
  push:
    branches: [master]
    paths:
      - cmd/**
      - go.*
      - Dockerfile
    tags:
      - "*"
  pull_request:
    branches: [master]
  release:
    types: [published]

permissions:
  contents: read
  packages: write

jobs:
  build:
    name: Build (${{ matrix.platform }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - platform: amd64
            runner: ubuntu-24.04
          - platform: arm64
            runner: ubuntu-24.04-arm
    outputs:
      amd64: ${{ steps.digest.outputs.amd64 }}
      arm64: ${{ steps.digest.outputs.arm64 }}
    steps:
      - uses: actions/checkout@v6

      - name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        id: meta
        env:
          DOCKER_METADATA_ANNOTATIONS_LEVELS: manifest,index
        with:
          images: |
            ${{ github.event_name == 'pull_request' && format('ttl.sh/k8s-gateway-pr-{0}-{1}', github.event.pull_request.number, github.sha) || 'ghcr.io/k8s-gateway/k8s_gateway' }}
          tags: |
            type=ref,event=branch,suffix=-${{ matrix.platform }}
            type=ref,event=pr,suffix=-${{ matrix.platform }}
            type=semver,pattern={{version}},suffix=-${{ matrix.platform }}
            type=semver,pattern={{major}}.{{minor}},suffix=-${{ matrix.platform }}
            type=raw,value=24h,suffix=-${{ matrix.platform }},enable=${{ github.event_name == 'pull_request' }}

      - name: Set output type
        id: build-type
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "type=type=image,name=ghcr.io/${{ github.repository_owner }}/k8s_gateway,push-by-digest=true,name-canonical=true,push=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "type=type=image,push=true" >> $GITHUB_OUTPUT
          else
            echo "type=type=docker" >> $GITHUB_OUTPUT
          fi

      - name: Build Image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        id: build
        with:
          build-args: |
            VENDOR=${{ github.repository_owner }}
            VERSION=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.version'] }}
            REVISION=${{ github.sha }}
            TARGETPLATFORM=${{ matrix.platform }}
          labels: |
            org.opencontainers.image.title=k8s_gateway
            org.opencontainers.image.url=https://ghcr.io/${{ github.repository_owner }}/k8s_gateway
            org.opencontainers.image.version=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.version'] }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.vendor=${{ github.repository_owner }}
          outputs: ${{ steps.build-type.outputs.type }}
          context: .
          platforms: linux/${{ matrix.platform }}
          provenance: false

      - name: Export Digest
        id: digest
        run: |
          echo "${{ matrix.platform }}=${{ steps.build.outputs.digest }}" >> "${GITHUB_OUTPUT}"

      - name: Display PR Image Location
        if: github.event_name == 'pull_request'
        run: |
          echo "::notice::PR image pushed to ttl.sh (24h TTL): ttl.sh/k8s-gateway-pr-${{ github.event.pull_request.number }}-${{ github.sha }}:pr-${{ github.event.pull_request.number }}-${{ matrix.platform }}"

  release:
    if: ${{ github.event_name == 'release' }}
    needs: build
    name: Release
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        id: meta
        env:
          DOCKER_METADATA_ANNOTATIONS_LEVELS: manifest,index
        with:
          images: ghcr.io/k8s-gateway/k8s_gateway
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Push Images
        id: push
        uses: Noelware/docker-manifest-action@v1
        with:
          tags: ${{ join(fromJSON(steps.meta.outputs.json).tags, ',') }}
          inputs: >-
            ghcr.io/${{ github.repository_owner }}/k8s_gateway@${{ needs.build.outputs.arm64 }},
            ghcr.io/${{ github.repository_owner }}/k8s_gateway@${{ needs.build.outputs.amd64 }}
          push: false
